{
  "hash": "61826691a7e41d5de82eb2eed77ad1df",
  "result": {
    "markdown": "---\ntitle: Untitled\nsubtitle: A slightly longer title\nformat:\n  360-analysis-html: default\nauthor: James Goldie\ndate: last-modified\ncode-fold: true\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.0\n✔ ggplot2   3.5.0     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.1     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(countrycode)\nlibrary(here)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nhere() starts at /workspaces/report-airpollution-health\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nhere(\"data\", \"raw\") |>\n  list.files(pattern = glob2rx(\"*.csv\"), full.names = TRUE) |>\n  map_dfr(read_csv) ->\nall_data\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRows: 18360 Columns: 10\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (6): measure, location, sex, age, rei, metric\ndbl (4): year, val, upper, lower\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\nRows: 36720 Columns: 11\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (7): measure, location, sex, age, cause, rei, metric\ndbl (4): year, val, upper, lower\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nall_data |>\n  filter(\n    cause == \"Neonatal preterm birth\",\n    metric == \"Rate\",\n    age == \"<28 days\") |>\n  select(location, rei, year, val, upper, lower) |>\n  write_csv(here(\"data\", \"lt28days-allsex-preterm-pollution-deathrate100k.csv\")) ->\npreterms\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nall_data |>\n  filter(\n    is.na(cause)) |>\n  select(location, rei, year, val, upper, lower) |>\n  write_csv(here(\"data\", \"agestd-allsex-allcause-pollutiontemp-sev.csv\")) ->\nall_cause\n```\n:::\n\n\nLet's do the all-cause stuff wide by year and by measure, so we can show it in Datawrapper as a table.\n\n:::{.callout-warning}\nDatawrapper allows spans of columns to be joined as row-by-row line charts within a table, but if two of these line charts sit next to each other, they need a spacer column in between them.\n\nUnfortunately, the title of that column shows up unless we hide it with CSS.\n\nThat, and the required column order, is why there's a bit of fiddliness here!\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_cause |>\n  select(-upper, -lower) |>\n  mutate(rei = case_match(rei,\n    \"High temperature\"                     ~ \"hightemp\",\n    \"Low temperature\"                      ~ \"lowtemp\",\n    \"Ambient particulate matter pollution\" ~ \"pollution\")) |>\n  pivot_wider(id_cols = location, names_from = c(rei, year), values_from = val) |>\n  # round figures off and add iso2 codes, then standardise country names\n  mutate(\n    across(where(is.numeric), ~ round(.x, 4)),\n    iso2 = countrycode(location, \"country.name\", \"iso2c\"),\n    country = countrycode(iso2, \"iso2c\", \"country.name\"),\n    label = paste0(\":\", tolower(iso2), \": \", country),\n    # datawrapper requires a couple of dummy 'spacer' columns for our\n    # table-of-charts\n    `<span style='display:none;'>S1</span>` = NA,\n    `<span style='display:none;'>S2</span>` = NA) |>\n  select(sort(tidyselect::peek_vars())) |>\n  relocate(\n    contains(\"<span style='display:none;'>S1</span>\"),\n    .after = starts_with(\"hightemp_\")) |>\n  relocate(\n    contains(\"<span style='display:none;'>S2</span>\"),\n    .after = starts_with(\"lowtemp_\")) |>\n  relocate(label, .before = starts_with(\"hightemp_\")) |>\n  write_csv(\n    here(\"data\", \"agestd-allsex-allcause-pollutiontemp-sev-wide.csv\"),\n    na = \"\") ->\nall_cause_widest\n```\n:::\n\n\nAnd one more where we just widen by risk, not year:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_cause |>\n  mutate(\n    rei = case_match(rei,\n      \"High temperature\"                     ~ \"hightemp\",\n      \"Low temperature\"                      ~ \"lowtemp\",\n      \"Ambient particulate matter pollution\" ~ \"pollution\"),\n    iso2 = countrycode(location, \"country.name\", \"iso2c\"),\n    country = countrycode(iso2, \"iso2c\", \"country.name\")) |>\n  select(-location) |>\n  pivot_wider(\n    id_cols = c(country, year),\n    names_from = rei,\n    values_from = c(val, upper, lower)) |>\n  write_csv(here(\"data\", \"agestd-allsex-allcause-pollutiontemp-sev-byrisk.csv\")) ->\nall_cause_byrisk\n```\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}